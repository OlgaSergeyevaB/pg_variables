--
-- PGPRO-7614: function pgv_free() inside autonomous transaction
--
select pgv_free();
 pgv_free 
----------
 
(1 row)

--
--
-- Functions pgv_free() + pgv_get() inside autonomous transaction; package
-- with regular variable; autonomous transaction with commit.
--
BEGIN;
	SELECT pgv_set('vars', 'int1', 1);
 pgv_set 
---------
 
(1 row)

	BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
		SELECT pgv_get('vars', 'int1', null::int);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
		SELECT pgv_free();
ERROR:  current transaction is aborted, commands ignored until end of transaction block
-- ERROR:  unrecognized package "vars"
		SELECT pgv_get('vars', 'int1', null::int);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
	COMMIT;
-- ERROR:  unrecognized package "vars"
	SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

ROLLBACK;
WARNING:  there is no transaction in progress
--
--
-- Function pgv_free() inside autonomous transaction; package with
-- regular variable; autonomous transaction with commit.
--
BEGIN;
	SELECT pgv_set('vars', 'int1', 1);
 pgv_set 
---------
 
(1 row)

	BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
		SELECT pgv_free();
ERROR:  current transaction is aborted, commands ignored until end of transaction block
	COMMIT;
-- ERROR:  unrecognized package "vars"
	SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

ROLLBACK;
WARNING:  there is no transaction in progress
--
--
-- Function pgv_free() inside autonomous transaction; package with
-- regular variable; autonomous transaction with rollback.
--
BEGIN;
	SELECT pgv_set('vars', 'int1', 1);
 pgv_set 
---------
 
(1 row)

	BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
		SELECT pgv_free();
ERROR:  current transaction is aborted, commands ignored until end of transaction block
	ROLLBACK;
-- ERROR:  unrecognized package "vars"
	SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

ROLLBACK;
WARNING:  there is no transaction in progress
--
--
-- Function pgv_free() inside autonomous transaction; package with
-- transactional variable; autonomous transaction with rollback.
--
BEGIN;
	SELECT pgv_set('vars', 'int1', 1, true);
ERROR:  variable "int1" already created as NOT TRANSACTIONAL
	BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
		SELECT pgv_free();
ERROR:  current transaction is aborted, commands ignored until end of transaction block
	ROLLBACK;
	SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

ROLLBACK;
WARNING:  there is no transaction in progress
--
--
-- Function pgv_free() inside autonomous transaction; package with
-- transactional variable; autonomous transaction with commit.
--
BEGIN;
	SELECT pgv_set('vars', 'int1', 1, true);
ERROR:  variable "int1" already created as NOT TRANSACTIONAL
	BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
		SELECT pgv_free();
ERROR:  current transaction is aborted, commands ignored until end of transaction block
	COMMIT;
-- ERROR:  unrecognized package "vars"
	SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

ROLLBACK;
WARNING:  there is no transaction in progress
--
--
-- Function pgv_free() inside recursive autonomous transactions.
--
BEGIN;
	BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
		SELECT pgv_set('vars', 'int1', 1);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
		BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
			BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
				SELECT pgv_free();
ERROR:  current transaction is aborted, commands ignored until end of transaction block
			COMMIT;
-- ERROR:  unrecognized package "vars"
			SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

		COMMIT;
WARNING:  there is no transaction in progress
-- ERROR:  unrecognized package "vars"
		SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

	COMMIT;
WARNING:  there is no transaction in progress
ROLLBACK;
WARNING:  there is no transaction in progress
--
--
-- Function pgv_free() inside recursive autonomous transactions;
-- recreating the package after deletion with using regular
-- variable.
--
BEGIN;
	SELECT pgv_set('vars', 'int1', 1);
 pgv_set 
---------
 
(1 row)

	BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
		BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
			SELECT pgv_get('vars', 'int1', null::int);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
			BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
				SELECT pgv_free();
ERROR:  current transaction is aborted, commands ignored until end of transaction block
			COMMIT;
-- ERROR:  unrecognized package "vars"
			SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

		COMMIT;
WARNING:  there is no transaction in progress
		SELECT pgv_set('vars', 'int1', 2);
 pgv_set 
---------
 
(1 row)

	COMMIT;
WARNING:  there is no transaction in progress
	SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       2
(1 row)

ROLLBACK;
WARNING:  there is no transaction in progress
--
--
-- Function pgv_free() inside recursive autonomous transactions;
-- recreating the package after deletion with using transactional
-- variable.
--
BEGIN;
	SELECT pgv_set('vars', 'int1', 1);
 pgv_set 
---------
 
(1 row)

	BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
		BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
			SELECT pgv_get('vars', 'int1', null::int);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
			BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
				SELECT pgv_free();
ERROR:  current transaction is aborted, commands ignored until end of transaction block
			COMMIT;
-- ERROR:  unrecognized package "vars"
			SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

		COMMIT;
WARNING:  there is no transaction in progress
		SELECT pgv_set('vars', 'int1', 2, true);
ERROR:  variable "int1" already created as NOT TRANSACTIONAL
		SELECT pgv_list();
   pgv_list    
---------------
 (vars,int1,f)
(1 row)

	COMMIT;
WARNING:  there is no transaction in progress
-- ERROR:  unrecognized package "vars"
	SELECT pgv_get('vars', 'int1', null::int);
 pgv_get 
---------
       1
(1 row)

ROLLBACK;
WARNING:  there is no transaction in progress
--
--
-- Do not free hash_seq_search scans of parent transaction. 
--
BEGIN;
	SELECT pgv_insert('test', 'x', row (1::int, 2::int), false);
 pgv_insert 
------------
 
(1 row)

	DECLARE r1_cur CURSOR FOR SELECT pgv_select('test', 'x');
	FETCH 1 IN r1_cur;
 pgv_select 
------------
 (1,2)
(1 row)

	BEGIN AUTONOMOUS;
ERROR:  syntax error at or near "AUTONOMOUS"
LINE 1: BEGIN AUTONOMOUS;
              ^
	ROLLBACK;
ROLLBACK;
WARNING:  there is no transaction in progress
select pgv_free();
 pgv_free 
----------
 
(1 row)

